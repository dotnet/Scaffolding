<!--
 Copyright (c) .NET Foundation. All rights reserved.
 Licensed under the Apache License, Version 2.0.
-->

<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
<!--
**********************************************************************************
Target: EvaluateProjectInfoForCodeGeneration

Outputs the Project Information needed for CodeGeneration to a file.

**********************************************************************************
-->

  <PropertyGroup>
    <EvaluateProjectInfoForCodeGenerationDependsOn>
      $(EvaluateProjectInfoForCodeGenerationDependsOn);
      ResolveReferences;
      ResolvePackageDependenciesDesignTime;
    </EvaluateProjectInfoForCodeGenerationDependsOn>
  </PropertyGroup>
  <Choose>
  <!-- For Portable Msbuild, MSBuildRuntimeType = 'Core'. For Desktop MsBuild, MSBuildRuntimeType = ''-->
    <When Condition="'$(MSBuildRuntimeType)' == ''">
      <PropertyGroup >
        <EvaluateProjectInfoForCodeGenerationAssemblyPath>$(MSBuildThisFileDirectory)\..\tools\net46\Microsoft.VisualStudio.Web.CodeGeneration.MsBuild.dll</EvaluateProjectInfoForCodeGenerationAssemblyPath>
      </PropertyGroup>
    </When>
    <Otherwise>
      <PropertyGroup >
          <EvaluateProjectInfoForCodeGenerationAssemblyPath>$(MSBuildThisFileDirectory)\..\tools\netcoreapp1.0\Microsoft.VisualStudio.Web.CodeGeneration.MsBuild.dll</EvaluateProjectInfoForCodeGenerationAssemblyPath>
      </PropertyGroup>
    </Otherwise>
  </Choose>
  <UsingTask TaskName="ProjectContextWriter"
             AssemblyFile="$(EvaluateProjectInfoForCodeGenerationAssemblyPath)" />
  
  <Target Name="EvaluateProjectInfoForCodeGeneration" DependsOnTargets="$(EvaluateProjectInfoForCodeGenerationDependsOn)">

    <ProjectContextWriter TargetFramework ="$(TargetFramework)"
                                       OutputFile ="$(OutputFile)"
                                       Name ="$(ProjectName)"
                                       ResolvedReferences ="@(ReferencePath)"
                                       PackageDependencies ="@(_DependenciesDesignTime)"
                                       ProjectReferences ="@(ProjectReference)"
                                       AssemblyFullPath ="$(TargetPath)"
                                       PackagesDirectory="$(NuGetPackageRoot)"
                                       OutputType="$(OutputType)"
                                       Platform="$(Platform)"
                                       RootNameSpace ="$(RootNamespace)"
                                       CompilationItems ="@(Compile)"
                                       TargetDirectory="$(TargetDir)"
                                       EmbeddedItems="@(EmbeddedResource)"
                                       Configuration="$(Configuration)"
                                       ProjectFullPath="$(MSBuildProjectFullPath)"/>

  </Target>
</Project>